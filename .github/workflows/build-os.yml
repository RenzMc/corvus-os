name: Build Corvus-Os

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      target:
        description: 'Build Target'
        required: true
        default: 'img_x86_64_defconfig'
        type: choice
        options:
          - qemu_x86_64_defconfig
          - qemu_aarch64_virt_defconfig
          - pc_x86_64_efi_defconfig
          - aarch64_efi_defconfig
          - img_x86_64_defconfig
          - img_aarch64_defconfig
          - iso_x86_64_defconfig
          - iso_aarch64_defconfig
          - tar_x86_64_defconfig
          - tar_aarch64_defconfig
      use_cache:
        description: 'Use build cache (recommended)'
        required: true
        default: true
        type: boolean
      buildroot_version:
        description: 'Buildroot Version'
        required: true
        default: '2023.02.x'
        type: choice
        options:
          - '2023.02.x'
          - '2024.02.x'
          - '2024.05.x'
          - '2024.08.x'
          - '2025.02.x'

env:
  BUILDROOT_VERSION: ${{ github.event.inputs.buildroot_version || '2023.02.x' }}
  BUILD_TARGET: ${{ github.event.inputs.target || 'img_x86_64_defconfig' }}
  USE_CACHE: ${{ github.event.inputs.use_cache || 'true' }}
  BUILDROOT_DIR: buildroot
  ARTIFACT_PREFIX: corvus-os-${{ env.BUILD_TARGET }}-${{ env.BUILDROOT_VERSION }}
  MAKEFLAGS: -j$(nproc)

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 720

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Debug workspace
      run: |
        echo "GITHUB_WORKSPACE = $GITHUB_WORKSPACE"
        pwd
        ls -la

    - name: Free Disk Space
      run: |
        echo "Freeing up disk space..."
        sudo rm -rf /usr/share/dotnet || true
        sudo rm -rf /opt/ghc || true
        sudo rm -rf /usr/local/share/boost || true
        df -h || true

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential gcc g++ make bzip2 xz-utils unzip bc file wget cpio rsync \
          python3 python3-pip python3-distutils python3-setuptools pkg-config \
          libncurses5-dev libssl-dev liblzma-dev libgmp-dev libbz2-dev ccache \
          git bison flex gettext make musl-tools || true
        # increase open files limit for heavy builds
        ulimit -n 4096 || true

    - name: Cache buildroot dl (optional)
      if: env.USE_CACHE == 'true'
      uses: actions/cache@v4
      with:
        path: |
          buildroot/dl
        key: ${{ runner.os }}-buildroot-dl-${{ env.BUILDROOT_VERSION }}-${{ matrix.cache_hash || '' }}
        restore-keys: |
          ${{ runner.os }}-buildroot-dl-${{ env.BUILDROOT_VERSION }}-
          ${{ runner.os }}-buildroot-dl-

    - name: Cache buildroot host output (optional)
      if: env.USE_CACHE == 'true'
      uses: actions/cache@v4
      with:
        path: |
          buildroot/output/host
        key: ${{ runner.os }}-buildroot-host-${{ env.BUILDROOT_VERSION }}-${{ env.BUILD_TARGET }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildroot-host-${{ env.BUILDROOT_VERSION }}-${{ env.BUILD_TARGET }}-
          ${{ runner.os }}-buildroot-host-${{ env.BUILDROOT_VERSION }}-

    - name: Clone Buildroot (shallow)
      run: |
        if [ ! -d "${{ env.BUILDROOT_DIR }}" ]; then
          git clone --single-branch --branch=${{ env.BUILDROOT_VERSION }} --depth=1 https://github.com/buildroot/buildroot ${{ env.BUILDROOT_DIR }}
        else
          echo "buildroot directory already exists"
        fi
        cd ${{ env.BUILDROOT_DIR }}
        git rev-parse --abbrev-ref HEAD || true
        git log -1 --oneline || true

    - name: Ensure BR2_EXTERNAL available (info)
      run: |
        echo "Checking for BR2_EXTERNAL overlays in repository root (..)"
        ls -la ..

    - name: Configure Buildroot (generate .config)
      working-directory: ${{ env.BUILDROOT_DIR }}
      run: |
        echo "Running make ${BUILD_TARGET} to generate .config"
        # This target usually writes .config based on defconfig name.
        make BR2_EXTERNAL=.. ${BUILD_TARGET}
        echo "---- .config head ----"
        head -n 60 .config || true

    - name: Build Corvus-Os (verbose, capture log)
      working-directory: ${{ env.BUILDROOT_DIR }}
      run: |
        echo "Building Corvus-Os (verbose). If runner mem runs out, reduce MAKEFLAGS (e.g. -j2)."
        # make verbose (V=1) + pipe stdout+stderr to top-level build.log
        # Use a limited -j if system memory is constrained
        make BR2_EXTERNAL=.. V=1 ${MAKEFLAGS} 2>&1 | tee ../build.log || (echo "BUILD FAILED, showing tail of log" && tail -n 200 ../build.log && exit 1)

    - name: Show Build Results (always)
      if: always()
      run: |
        echo "=== Build results preview ==="
        ls -lh buildroot/output || true
        echo "Images:"
        ls -lh buildroot/output/images || true
        echo "Target rootfs preview:"
        du -sh buildroot/output/target || true
        echo "============================"
        echo "Last 120 lines of build.log"
        tail -n 120 build.log || true

    - name: Package images & rootfs into tar.gz
      if: always()
      run: |
        mkdir -p artifacts
        TIMESTAMP=$(date -u +%Y%m%dT%H%M%SZ)
        ART_NAME="${ARTIFACT_PREFIX}-${TIMESTAMP}.tar.gz"
        # include images dir and target (rootfs) and host and entire output/images
        tar -czf artifacts/${ART_NAME} -C buildroot output/images output/target output/staging output/host || tar -czf artifacts/${ART_NAME} -C buildroot output/images || true
        ls -lh artifacts || true
      shell: bash

    - name: Upload Build Images (artifact)
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_PREFIX }}-images
        path: artifacts/
        retention-days: 30

    - name: Upload build.log (always)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ env.BUILD_TARGET }}
        path: build.log
        retention-days: 7

    - name: Create Release Assets (tag builds)
      if: success() && startsWith(github.ref, 'refs/tags/')
      run: |
        cd buildroot/output/images || exit 0
        tar -czf ${ARTIFACT_PREFIX}-${GITHUB_REF#refs/tags/}.tar.gz * || true

    - name: Upload to Release (tag builds)
      if: success() && startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: buildroot/output/images/*.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
