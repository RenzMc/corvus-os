name: Build Corvus-Os

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      target:
        description: 'Build Target'
        required: true
        default: 'img_x86_64_defconfig'
        type: choice
        options:
          - qemu_x86_64_defconfig
          - qemu_aarch64_virt_defconfig
          - pc_x86_64_efi_defconfig
          - aarch64_efi_defconfig
          - img_x86_64_defconfig
          - img_aarch64_defconfig
          - iso_x86_64_defconfig
          - iso_aarch64_defconfig
          - tar_x86_64_defconfig
          - tar_aarch64_defconfig
      use_cache:
        description: 'Use build cache (recommended)'
        required: true
        default: true
        type: boolean
      buildroot_version:
        description: 'Buildroot Version'
        required: true
        default: '2023.02.x'
        type: choice
        options:
          - '2023.02.x'
          - '2024.02.x'
          - '2024.05.x'
          - '2024.08.x'
          - '2025.02.x'

env:
  BUILDROOT_VERSION: ${{ github.event.inputs.buildroot_version || '2023.02.x' }}
  BUILD_TARGET: ${{ github.event.inputs.target || 'img_x86_64_defconfig' }}
  USE_CACHE: ${{ github.event.inputs.use_cache || 'true' }}

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Corvus-Os
      uses: actions/checkout@v4
      
    - name: Free Disk Space
      run: |
        echo "Freeing up disk space..."
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        df -h
        
    - name: Install Dependencies
      run: |
        echo "Installing build dependencies..."
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          gcc g++ make \
          bzip2 xz-utils \
          unzip bc \
          file wget cpio rsync \
          python3 python3-pip \
          libncurses5-dev \
          git
        
    - name: Cache Buildroot DL Directory
      if: env.USE_CACHE == 'true'
      uses: actions/cache@v4
      with:
        path: corvus-os/buildroot/dl
        key: ${{ runner.os }}-buildroot-dl-${{ env.BUILDROOT_VERSION }}-${{ hashFiles('**/Config.in', '**/*.mk') }}
        restore-keys: |
          ${{ runner.os }}-buildroot-dl-${{ env.BUILDROOT_VERSION }}-
          ${{ runner.os }}-buildroot-dl-
          
    - name: Cache Buildroot Output
      if: env.USE_CACHE == 'true'
      uses: actions/cache@v4
      with:
        path: |
          corvus-os/buildroot/output/build
          corvus-os/buildroot/output/host
        key: ${{ runner.os }}-buildroot-output-${{ env.BUILDROOT_VERSION }}-${{ env.BUILD_TARGET }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildroot-output-${{ env.BUILDROOT_VERSION }}-${{ env.BUILD_TARGET }}-
          ${{ runner.os }}-buildroot-output-${{ env.BUILDROOT_VERSION }}-
          
    - name: Clone Buildroot
      working-directory: corvus-os
      run: |
        echo "Cloning Buildroot $BUILDROOT_VERSION..."
        if [ ! -d "buildroot" ]; then
          git clone --single-branch --branch=$BUILDROOT_VERSION \
                    --no-tags --depth=1 \
                    https://github.com/buildroot/buildroot
        fi
        cd buildroot
        git log -1
        
    - name: Configure Build
      working-directory: corvus-os
      run: |
        echo "Configuring Corvus-Os build for target: $BUILD_TARGET"
        cd buildroot
        make BR2_EXTERNAL=.. $BUILD_TARGET
        
    - name: Show Configuration
      working-directory: corvus-os
      run: |
        echo "=== Build Configuration ==="
        echo "Buildroot Version: $BUILDROOT_VERSION"
        echo "Target: $BUILD_TARGET"
        echo "Cache Enabled: $USE_CACHE"
        echo "=========================="
        cd buildroot
        make BR2_EXTERNAL=.. show-info || true
        
    - name: Build Corvus-Os
      working-directory: corvus-os
      run: |
        echo "Building Corvus-Os... This may take 1-3 hours"
        cd buildroot
        make BR2_EXTERNAL=.. -j$(nproc) 2>&1 | tee ../build.log
        
    - name: Show Build Results
      if: always()
      working-directory: corvus-os
      run: |
        echo "=== Build Results ==="
        cd buildroot
        ls -lh output/images/ || echo "No images found"
        du -sh output/images/* || true
        echo "===================="
        
    - name: Upload Build Images
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: corvus-os-${{ env.BUILD_TARGET }}-${{ env.BUILDROOT_VERSION }}
        path: |
          corvus-os/buildroot/output/images/*
          !corvus-os/buildroot/output/images/*.tmp
        retention-days: 30
        
    - name: Upload Build Log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ env.BUILD_TARGET }}
        path: corvus-os/build.log
        retention-days: 7
        
    - name: Create Release Assets
      if: success() && startsWith(github.ref, 'refs/tags/')
      working-directory: corvus-os/buildroot/output/images
      run: |
        tar -czf corvus-os-${{ env.BUILD_TARGET }}-${GITHUB_REF#refs/tags/}.tar.gz *
        
    - name: Upload to Release
      if: success() && startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: corvus-os/buildroot/output/images/*.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
  build-matrix:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - qemu_x86_64_defconfig
          - qemu_aarch64_virt_defconfig
          - img_x86_64_defconfig
          - img_aarch64_defconfig
      fail-fast: false
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Build ${{ matrix.target }}
      run: |
        echo "Building Corvus-Os for ${{ matrix.target }}"
        echo "This is a matrix build - multiple targets in parallel"
        # Matrix builds can be enabled by duplicating the build steps from the main job
